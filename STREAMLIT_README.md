# LongCat-Image Streamlit 网页界面

一个用户友好的 LongCat-Image 网页界面,使用 Streamlit 构建,支持文生图和图像编辑功能。

## 功能特性

- **文生图生成**: 从中英文文本提示词生成高质量图像
- **图像编辑**: 使用自然语言指令编辑现有图像
- **双语支持**: 完整支持中文和英文文字渲染
- **用户友好界面**: 直观的网页界面,支持实时参数调整
- **CPU 卸载选项**: 针对显存有限的 GPU 提供内存高效推理
- **批量生成**: 单次运行生成多张图像
- **下载支持**: 轻松下载生成/编辑的图像

## 安装

1. 安装 Streamlit (如果尚未安装):

```bash
pip install streamlit
```

2. 确保已安装 LongCat-Image 依赖:

```bash
pip install -r requirements.txt
python setup.py develop
```

## 模型下载

使用 huggingface-cli 下载所需模型:

```bash
# 下载文生图模型
huggingface-cli download meituan-longcat/LongCat-Image --local-dir ./weights/LongCat-Image

# 下载图像编辑模型
huggingface-cli download meituan-longcat/LongCat-Image-Edit --local-dir ./weights/LongCat-Image-Edit
```

## 运行应用

启动 Streamlit 应用:

```bash
streamlit run app.py
```

或使用启动脚本:

```bash
./run_app.sh
```

应用将在默认浏览器中打开,地址为 `http://localhost:8501`。

## 使用说明

### 文生图生成

1. 导航到"文生图"标签页
2. 输入提示词(中文或英文)
3. 调整参数:
   - **宽度/高度**: 输出图像尺寸 (512-2048 像素)
   - **引导强度**: 控制对提示词的遵循程度 (1.0-10.0)
   - **推理步数**: 质量与速度的权衡 (10-100 步)
   - **启用 CFG 重归一化**: 改善色彩和对比度
   - **启用提示词重写**: 使用内置提示词增强
   - **图像数量**: 生成多个变体
   - **随机种子**: 设置以获得可重现结果 (-1 表示随机)
4. 点击"生成图像"
5. 使用下载按钮下载生成的图像

### 图像编辑

1. 导航到"图像编辑"标签页
2. 上传图像 (PNG、JPG 或 JPEG)
3. 输入编辑指令 (例如:"将猫变成狗")
4. 调整参数(与文生图类似)
5. 点击"编辑图像"
6. 使用下载按钮下载编辑后的图像

## 重要说明

### 文字渲染

当生成或编辑包含文字的图像时,**必须将目标文字用引号("")括起来**以获得最佳质量:

- ✅ 正确: `生成一张带有"欢迎光临"文字的海报`
- ❌ 错误: `生成一张带有欢迎光临文字的海报`

这是必需的,因为分词器会对引号内的内容应用字符级编码。

### 显存需求

- **启用 CPU 卸载**(默认):
  - 文生图: 约 17 GB 显存
  - 图像编辑: 约 19 GB 显存
  - 推理速度较慢但避免显存不足错误

- **禁用 CPU 卸载**:
  - 需要更高显存 (推荐 24GB+)
  - 推理速度更快

可以在侧边栏中切换此选项。

## 模型配置

默认模型路径为:
- 文生图: `./weights/LongCat-Image`
- 图像编辑: `./weights/LongCat-Image-Edit`

如果模型位于其他位置,可以在侧边栏中修改这些路径。

## 高级选项

### 使用外部提示词改写器

为了获得更好的效果,可以使用外部 LLM 进行提示词优化。修改代码以启用 `prompt_rewrite_deepseek` 函数(需要 API 访问)。

### 自定义参数

界面提供了合理的默认值,但可以自由尝试:

- **低引导强度 (2.0-3.5)**: 更有创意,不太字面
- **高引导强度 (5.0-7.0)**: 更精确,紧密遵循提示词
- **更多步数 (60-100)**: 更高质量但更慢
- **更少步数 (20-30)**: 更快但可能降低质量

## 故障排除

### 显存不足 (OOM) 错误

- 在侧边栏中启用"CPU 卸载"
- 降低图像尺寸
- 减少每次运行生成的图像数量
- 关闭其他占用 GPU 的应用程序

### 找不到模型

- 在侧边栏中验证模型路径
- 确保模型已完整下载
- 检查目录结构是否符合预期格式

### 推理速度慢

- 如果有足够显存,禁用 CPU 卸载
- 减少推理步数(最少 20-30 步可获得可接受的质量)
- 降低图像尺寸

## 系统要求

- **GPU**: 支持 CUDA 的 NVIDIA GPU (推荐 16GB+ 显存)
- **内存**: 推荐 32GB+
- **Python**: 3.10+
- **CUDA**: 与 PyTorch 2.6.0 兼容

## 许可证

此网页界面遵循与 LongCat-Image 相同的 Apache 2.0 许可证。
